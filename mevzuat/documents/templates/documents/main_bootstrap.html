{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4">Document Search</h1>
    <form id="search-form" class="row g-3 mb-4">
        <div class="col-auto">
            <input type="text" id="query" class="form-control" placeholder="Search query">
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary mb-3">Search</button>
        </div>
    </form>
    <canvas id="documentsChart" class="mb-4" height="100"></canvas>
    <ul id="results" class="list-group"></ul>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-8V5YH14r2raXIiQunlslqY5T2r8j04YfGLwRoTSesxNUFD6oYBeb5GsyhQOdE31Q" crossorigin="anonymous"></script>
<script>
async function loadChart() {
    try {
        const resp = await fetch('/api/documents/counts?interval=year');
        const data = await resp.json();
        const labels = [...new Set(data.map(d => d.period))];
        const types = [...new Set(data.map(d => d.type))];
        const datasets = types.map(type => ({
            label: type,
            data: labels.map(label => {
                const entry = data.find(d => d.period === label && d.type === type);
                return entry ? entry.count : 0;
            })
        }));
        new Chart(document.getElementById('documentsChart'), {
            type: 'line',
            data: { labels, datasets },
            options: { responsive: true, maintainAspectRatio: false }
        });
    } catch (err) {
        console.error('Failed to load chart', err);
    }
}

async function performSearch(query) {
    const resp = await fetch('/api/documents/search?query=' + encodeURIComponent(query));
    const data = await resp.json();
    const list = document.getElementById('results');
    list.innerHTML = '';
    if (data.data) {
        data.data.forEach(item => {
            const title = item.metadata?.title || item.title || item.id;
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = title;
            list.appendChild(li);
        });
    }
}

document.getElementById('search-form').addEventListener('submit', ev => {
    ev.preventDefault();
    const q = document.getElementById('query').value;
    if (q) {
        performSearch(q);
    }
});

loadChart();
</script>
</body>
</html>
