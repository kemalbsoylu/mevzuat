{% extends "base.html" %}

{% block title %}Mevzuat{% endblock %}

{% block extra_css %}
<style>
  .legend-item { display: flex; align-items: center; margin-bottom: .25rem; }
  .legend-color { width: 12px; height: 12px; display: inline-block; margin-right: .5rem; border-radius: 2px; }
</style>
{% endblock %}

{% block content %}
<div class="bg-body-tertiary rounded p-3 mb-4">
  <div class="mb-3">
    <div id="typeFilter" class="btn-group" role="group"></div>
  </div>
  <div class="mb-3">
    <div id="rangeButtons" class="btn-group me-2" role="group">
      <button type="button" class="btn btn-outline-secondary active" data-range="all">All</button>
      <button type="button" class="btn btn-outline-secondary" data-range="thisYear">This Year</button>
      <button type="button" class="btn btn-outline-secondary" data-range="lastYear">Last Year</button>
      <button type="button" class="btn btn-outline-secondary" data-range="30days">30 Days</button>
      <button type="button" class="btn btn-outline-secondary" data-range="custom">Custom</button>
    </div>
    <input type="date" class="form-control d-inline-block me-2 d-none" id="startDate">
    <input type="date" class="form-control d-inline-block d-none" id="endDate">
  </div>
  <form class="d-flex" id="searchForm">
    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" id="searchInput">
    <button class="btn btn-outline-success" type="submit">Search</button>
  </form>
</div>

<div class="row">
  <div class="col-lg-8">
    <canvas id="documentsChart" height="150"></canvas>
  </div>
  <div class="col-lg-4">
    <div id="chartLegend" class="small"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const palette = ['#0d6efd','#6c757d','#198754','#dc3545','#ffc107','#0dcaf0','#6610f2','#d63384','#20c997','#fd7e14'];
    const typeFilter = document.getElementById('typeFilter');
    const rangeButtons = document.getElementById('rangeButtons');
    let currentRange = 'all';
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const legend = document.getElementById('chartLegend');
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    let chart;
    const typeMap = {}; // label -> {id, slug, color, visible}

    function slugify(str) {
      return str
        .toString()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    loadTypes();

    async function loadTypes() {
      try {
        const res = await fetch('/api/documents/types');
        const types = await res.json();
        types.forEach((t, idx) => {
          const slug = slugify(t.label);
          typeMap[t.label] = { id: t.id, slug, color: palette[idx % palette.length], visible: true };
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-outline-secondary active';
          btn.textContent = t.label;
          btn.setAttribute('data-label', t.label);
          typeFilter.appendChild(btn);
          btn.addEventListener('click', () => {
            btn.classList.toggle('active');
            const label = btn.getAttribute('data-label');
            typeMap[label].visible = btn.classList.contains('active');
            updateChart();
          });
        });
        updateChart();
      } catch (err) {
        console.error(err);
      }
    }

    function getRange() {
      const opt = currentRange;
      const today = new Date();
      let start = '', end = '', interval = 'year';
      if (opt === 'thisYear') {
        start = `${today.getFullYear()}-01-01`;
        end = today.toISOString().split('T')[0];
        interval = 'month';
      } else if (opt === 'lastYear') {
        const year = today.getFullYear() - 1;
        start = `${year}-01-01`;
        end = `${year}-12-31`;
        interval = 'month';
      } else if (opt === '30days') {
        const past = new Date();
        past.setDate(today.getDate() - 30);
        start = past.toISOString().split('T')[0];
        end = today.toISOString().split('T')[0];
        interval = 'day';
      } else if (opt === 'custom') {
        start = startDateInput.value;
        end = endDateInput.value;
        interval = 'day';
      }
      return { start, end, interval };
    }

    async function fetchCounts() {
      const { start, end, interval } = getRange();
      const params = new URLSearchParams();
      params.set('interval', interval);
      if (start) params.set('start_date', start);
      if (end) params.set('end_date', end);
      const res = await fetch('/api/documents/counts?' + params.toString());
      return await res.json();
    }

    async function updateChart() {
      const rows = await fetchCounts();
      const visibleLabels = Object.keys(typeMap).filter(k => typeMap[k].visible);
      const periods = Array.from(new Set(rows.map(r => r.period))).sort();
      const datasetMap = {};
      visibleLabels.forEach(l => datasetMap[l] = Array(periods.length).fill(0));
      rows.forEach(r => {
        const idx = periods.indexOf(r.period);
        if (idx !== -1 && datasetMap[r.type] !== undefined) {
          datasetMap[r.type][idx] = r.count;
        }
      });
      const datasets = visibleLabels.map(l => ({
        label: l,
        data: datasetMap[l],
        backgroundColor: typeMap[l].color,
        stack: 'docs'
      }));
      const ctx = document.getElementById('documentsChart');
      if (!chart) {
        chart = new Chart(ctx, {
          type: 'bar',
          data: { labels: periods, datasets },
          options: {
            responsive: true,
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
          }
        });
      } else {
        chart.data.labels = periods;
        chart.data.datasets = datasets;
        chart.update();
      }
      updateLegend(rows, periods);
    }

    function updateLegend(rows, periods) {
      if (!rows.length) {
        legend.innerHTML = '<p>No data</p>';
        return;
      }
      const totals = {};
      rows.forEach(r => {
        totals[r.type] = (totals[r.type] || 0) + r.count;
      });
      const first = periods[0];
      const last = periods[periods.length - 1];
      let html = `<div class="mb-2"><strong>Date Range:</strong> ${first} â€“ ${last}</div>`;
      html += '<ul class="list-unstyled">';
      Object.keys(typeMap).forEach(label => {
        if (typeMap[label].visible) {
          html += `<li class="legend-item"><span class="legend-color" style="background:${typeMap[label].color}"></span>${label}: ${totals[label] || 0}</li>`;
        }
      });
      html += '</ul>';
      legend.innerHTML = html;
    }

    rangeButtons.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        rangeButtons.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentRange = btn.getAttribute('data-range');
        const custom = currentRange === 'custom';
        startDateInput.classList.toggle('d-none', !custom);
        endDateInput.classList.toggle('d-none', !custom);
        updateChart();
      });
    });
    startDateInput.addEventListener('change', () => updateChart());
    endDateInput.addEventListener('change', () => updateChart());

    searchForm.addEventListener('submit', e => {
      e.preventDefault();
      const q = searchInput.value.trim();
      if (!q) return;
      const selectedSlugs = Object.keys(typeMap)
        .filter(label => typeMap[label].visible)
        .map(label => typeMap[label].slug);
      const params = new URLSearchParams({ query: q });
      const { start, end } = getRange();
      if (start) params.set('start_date', start);
      if (end) params.set('end_date', end);
      if (selectedSlugs.length === 1) {
        params.set('type', selectedSlugs[0]);
      }
      window.location.href = '/search?' + params.toString();
    });
  });
</script>
{% endblock %}
